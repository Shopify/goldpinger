<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Goldpinger</title>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ariutta.github.io/svg-pan-zoom/dist/svg-pan-zoom.js"></script>

    <link rel="stylesheet" href="/static/application.css"></link>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Goldpinger</a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Latency Matrix</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/static/graph.html">Host Graph</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/metrics">Raw Metrics</a>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
          <button id="reload-graph" class="btn btn-outline-success" type="submit">reload</button>
        </form>
      </div>
    </nav>

    <div class="container-fluid body h-100">
      <figure class="latency-grid"></figure>
    </div>

    <script>
    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("top", 0)
      .style("opacity", 0);

    // SVG container to render the grid
    var padding = 1;
    var latency_grid = d3.select(".latency-grid").append("svg");

    var main = function(timeout) {
      d3.json("/check_all?timeout=5").then(function(data) {
        // Parse data into an adjacency matrix format
        var matrix = [];
        data.hosts.forEach(function(host) {
          var host_data = data.responses[host.podIP];
          var host_row = {
            host_ip: host.hostIP,
            pod_ip: host.podIP,
            host_ok: host_data && host_data.OK,
            neighbours: []
          };

          data.hosts.forEach(function(neighbour) {
            var neighbour_data;
            if(host_data && host_data.response) {
              neighbour_data = host_data.response[neighbour.podIP];
            }

            host_row.neighbours.push({
              from: host.podIP,
              pod_ip: neighbour.podIP,
              response: neighbour_data || { OK: false },
            });
          });

          matrix.push(host_row);
        });

        var width = matrix.length + padding;
        latency_grid.attr("viewBox", "-" + padding + " -" + padding + " " + width + " " + width);

        // Function applied to each row in the grid
        function row(row) {
          d3.select(this).selectAll(".node")
            .data(row.neighbours)
            .enter()
              .append("rect")
              .attr("class", "node")
              .attr("x", function(_data, index) { return index; })
              .attr("width", 1)
              .attr("height", 1)
              .attr("title", "test")
              .attr("data-toggle", "tooltip")
              .style("fill", function(data) { return data.response.OK ? "#4a4" : "#d44"; })
              .style("stroke", function(data) { return data.response.OK ? "#383" : "#a33"; })
              .on("mouseover", function(data) {
                tooltip.transition()
                  .duration(200)
                  .style("opacity", 0.8);
              })
              .on("mousemove", function(data) {
                tooltip.text(JSON.stringify(data.response, undefined, 4))
                  .style("left", d3.event.pageX + "px")
                  .style("top", d3.event.pageY + "px");
              })
              .on("mouseout", function() {
                tooltip.transition()
                  .duration(200)
                  .style("opacity", 0);
              });
        }

        var rows = latency_grid.selectAll(".row")
          .data(matrix)
          .enter()
            .append("g")
            .attr("class", "row")
            .attr("transform", function(_data, index) { return "translate(0," + index + ")"; })
            .each(row);

        // Add row headers
        var column = latency_grid.selectAll(".row_header")
          .data(matrix)
          .enter()
            .append("g")
            .style("text-anchor", "end")
            .attr("class", "row_header")
            .attr("transform", function(_data, index) { return "translate(-0.1, " + (index + 0.5) + ")"; });

        column.append("text")
          .text(function(data) { return data.host_ip });

        // Add column headers
        var column = latency_grid.selectAll(".column_header")
          .data(matrix)
          .enter()
            .append("g")
            .attr("class", "column_header")
            .attr("transform", function(_data, index) { return "translate(" + (index + 0.5) + ", -0.1) rotate(-45)"; });

        column.append("text")
          .text(function(data) { return data.host_ip });

        // Support panning and zooming
        svgPanZoom('.latency-grid > svg', {
          minZoom: 0.1,
          zoomScaleSensitivity: 0.5,
        });
      });
    };

    $(function () {
      $("#reload-graph").click(main);

      main();
    })
    </script>
  </body>
</html>
